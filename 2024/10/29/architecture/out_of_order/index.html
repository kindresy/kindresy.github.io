<!DOCTYPE html>
<html lang="zh-Hans">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)"><meta name="generator" content="Hexo 7.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css" integrity="sha256-5eIC48iZUHmSlSUz9XtjRyK2mzQkHScZY1WdMaoz74E=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"kindresy.github.io","root":"/","images":"/images","scheme":"Pisces","darkmode":true,"version":"8.21.0","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"hljswrap":true,"copycode":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"}}</script><script src="/js/config.js"></script>

    <meta name="description" content="�������ϵ�ṹ - ���������ִ�������������">
<meta property="og:type" content="article">
<meta property="og:title" content="��������vsִ������">
<meta property="og:url" content="https://kindresy.github.io/2024/10/29/architecture/out_of_order/index.html">
<meta property="og:site_name" content="Coffe Pattern">
<meta property="og:description" content="�������ϵ�ṹ - ���������ִ�������������">
<meta property="og:locale">
<meta property="og:image" content="https://kindresy.github.io/stuff/BCD_MEM_barrier.png">
<meta property="article:published_time" content="2024-10-29T02:15:16.000Z">
<meta property="article:modified_time" content="2024-10-29T02:14:38.361Z">
<meta property="article:author" content="Luyuan">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://kindresy.github.io/stuff/BCD_MEM_barrier.png">


<link rel="canonical" href="https://kindresy.github.io/2024/10/29/architecture/out_of_order/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-Hans","comments":true,"permalink":"https://kindresy.github.io/2024/10/29/architecture/out_of_order/","path":"2024/10/29/architecture/out_of_order/","title":"��������vsִ������"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>��������vsִ������ | Coffe Pattern</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">Coffe Pattern</p>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">Linux Kernel Driver</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="Search" role="button">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a></li>
  </ul>
</nav>




</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD"><span class="nav-number">1.</span> <span class="nav-text">����</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%CA%B2o%EF%BF%BDDZ%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%D6%B4%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD"><span class="nav-number">2.</span> <span class="nav-text">ʲô�Ǳ��������ִ������</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD"><span class="nav-number">2.1.</span> <span class="nav-text">��������</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%D6%B4%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD"><span class="nav-number">2.2.</span> <span class="nav-text">ִ������</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD1"><span class="nav-number">2.3.</span> <span class="nav-text">����1</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD2"><span class="nav-number">2.4.</span> <span class="nav-text">����2</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD3"><span class="nav-number">2.5.</span> <span class="nav-text">����3</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD4"><span class="nav-number">2.6.</span> <span class="nav-text">����4</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD5"><span class="nav-number">2.7.</span> <span class="nav-text">����5</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ARM-Arch%EF%BF%BD%EF%BF%BDStrongly-Order"><span class="nav-number">2.8.</span> <span class="nav-text">ARM Arch��Strongly Order</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#BCM%EF%BF%BD%D6%B2%EF%BF%BD%EF%BF%BD%EF%B7%A2%EF%BF%BD%D6%B5%EF%BF%BD%D2%BB%EF%BF%BD%EF%BF%BD%CF%B8%EF%BF%BD%EF%BF%BD"><span class="nav-number">2.9.</span> <span class="nav-text">BCM�ֲ��﷢�ֵ�һ��ϸ��</span></a></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Luyuan</p>
  <div class="site-description" itemprop="description">ARM/Liunx Kernel/OS/Driver</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">8</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">5</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
  </nav>
</div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="https://kindresy.github.io/2024/10/29/architecture/out_of_order/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Luyuan">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Coffe Pattern">
      <meta itemprop="description" content="ARM/Liunx Kernel/OS/Driver">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="��������vsִ������ | Coffe Pattern">
      <meta itemprop="description" content="�������ϵ�ṹ - ���������ִ�������������">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          ��������vsִ������
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2024-10-29 10:15:16 / Modified: 10:14:38" itemprop="dateCreated datePublished" datetime="2024-10-29T10:15:16+08:00">2024-10-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/arch/" itemprop="url" rel="index"><span itemprop="name">arch</span></a>
        </span>
    </span>

  
    <span class="post-meta-item" title="Views" id="busuanzi_container_page_pv">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">Views: </span>
      <span id="busuanzi_value_page_pv"></span>
    </span>
</div>

            <div class="post-description">�������ϵ�ṹ - ���������ִ�������������</div>
        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><h2 id="����"><a href="#����" class="headerlink" title="����"></a>����</h2><p>����������һ��linux�ں˶�writel��readl��ʵ�֣��漰����dmb��imb��������ָ���ȥ��������Ƶ��˽�Ƚ�ģ�������Բ�����һЩ���ϣ���һ�¼�¼��</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">if</span> __LINUX_ARM_ARCH__ &gt;= 7</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> isb(option) __asm__ __volatile__ (<span class="string">&quot;isb &quot;</span> #option : : : <span class="string">&quot;memory&quot;</span>)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> dsb(option) __asm__ __volatile__ (<span class="string">&quot;dsb &quot;</span> #option : : : <span class="string">&quot;memory&quot;</span>)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> dmb(option) __asm__ __volatile__ (<span class="string">&quot;dmb &quot;</span> #option : : : <span class="string">&quot;memory&quot;</span>)</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_THUMB2_KERNEL</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CSDB	<span class="string">&quot;.inst.w 0xf3af8014&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CSDB	<span class="string">&quot;.inst	0xe320f014&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> csdb() __asm__ __volatile__(CSDB : : : <span class="string">&quot;memory&quot;</span>)</span></span><br><span class="line"><span class="meta">#<span class="keyword">elif</span> defined(CONFIG_CPU_XSC3) || __LINUX_ARM_ARCH__ == 6</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> isb(x) __asm__ __volatile__ (<span class="string">&quot;mcr p15, 0, %0, c7, c5, 4&quot;</span> \</span></span><br><span class="line"><span class="meta">				    : : <span class="string">&quot;r&quot;</span> (0) : <span class="string">&quot;memory&quot;</span>)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> dsb(x) __asm__ __volatile__ (<span class="string">&quot;mcr p15, 0, %0, c7, c10, 4&quot;</span> \</span></span><br><span class="line"><span class="meta">				    : : <span class="string">&quot;r&quot;</span> (0) : <span class="string">&quot;memory&quot;</span>)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> dmb(x) __asm__ __volatile__ (<span class="string">&quot;mcr p15, 0, %0, c7, c10, 5&quot;</span> \</span></span><br><span class="line"><span class="meta">				    : : <span class="string">&quot;r&quot;</span> (0) : <span class="string">&quot;memory&quot;</span>)</span></span><br><span class="line"><span class="meta">#<span class="keyword">elif</span> defined(CONFIG_CPU_FA526)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> isb(x) __asm__ __volatile__ (<span class="string">&quot;mcr p15, 0, %0, c7, c5, 4&quot;</span> \</span></span><br><span class="line"><span class="meta">				    : : <span class="string">&quot;r&quot;</span> (0) : <span class="string">&quot;memory&quot;</span>)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> dsb(x) __asm__ __volatile__ (<span class="string">&quot;mcr p15, 0, %0, c7, c10, 4&quot;</span> \</span></span><br><span class="line"><span class="meta">				    : : <span class="string">&quot;r&quot;</span> (0) : <span class="string">&quot;memory&quot;</span>)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> dmb(x) __asm__ __volatile__ (<span class="string">&quot;&quot;</span> : : : <span class="string">&quot;memory&quot;</span>)</span></span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> isb(x) __asm__ __volatile__ (<span class="string">&quot;&quot;</span> : : : <span class="string">&quot;memory&quot;</span>)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> dsb(x) __asm__ __volatile__ (<span class="string">&quot;mcr p15, 0, %0, c7, c10, 4&quot;</span> \</span></span><br><span class="line"><span class="meta">				    : : <span class="string">&quot;r&quot;</span> (0) : <span class="string">&quot;memory&quot;</span>)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> dmb(x) __asm__ __volatile__ (<span class="string">&quot;&quot;</span> : : : <span class="string">&quot;memory&quot;</span>)</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> mb()		__arm_heavy_mb()</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> rmb()		dsb()</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> wmb()		__arm_heavy_mb(st)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> dma_rmb()	dmb(osh)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> dma_wmb()	dmb(oshst)</span></span><br><span class="line"><span class="meta">#in</span></span><br><span class="line">clude &lt;<span class="keyword">asm</span>/barrier.h&gt;</span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __iormb()		rmb()</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __iowmb()		wmb()</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> writeb_relaxed(v,c)	__raw_writeb(v,c)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> writew_relaxed(v,c)	__raw_writew((__force u16) cpu_to_le16(v),c)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> writel_relaxed(v,c)	__raw_writel((__force u32) cpu_to_le32(v),c)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> readb(c)		(&#123; u8  __v = readb_relaxed(c); __iormb(); __v; &#125;)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> readw(c)		(&#123; u16 __v = readw_relaxed(c); __iormb(); __v; &#125;)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> readl(c)		(&#123; u32 __v = readl_relaxed(c); __iormb(); __v; &#125;)</span></span><br></pre></td></tr></table></figure>

<h2 id="ʲo�DZ��������ִ������"><a href="#ʲo�DZ��������ִ������" class="headerlink" title="ʲô�Ǳ��������ִ������"></a>ʲô�Ǳ��������ִ������</h2><h3 id="��������"><a href="#��������" class="headerlink" title="��������"></a>��������</h3><p>�ִ������ܱ�������Ŀ�����Ż�ʱ���߱���ָ����������Ż������������������ԶԷô�ָ��������򣬼����߼��ϲ���Ҫ�ķô棬�Դ����������Cache�����ʺ�CPU��Load&#x2F;Store��Ԫ�Ĺ���Ч��<br>�򿪱����Ż��󣬿������ɵĻ���벢û���ϸ��մ�����߼�˳��������������</p>
<h3 id="ִ������"><a href="#ִ������" class="headerlink" title="ִ������"></a>ִ������</h3><p>�ڴ�������ִ��ʱ�������ָ�������ִ���꣬���Ǵ������ġ�����ִ�У�Out-of-OrderExecution��?������<br>�߼���CPU���Ը����Լ��������֯���ԣ����ô�ָ����������ִ�С�������ַ�ķ��ʿ��ܻ���ִ�У���Ϊ�������������ʸߡ��еĻ������ô�ķ������������ǰ��һ���ô�ָ����Ϊ���治���У���ɳ���ʱ�Ĵ洢����ʱ������ķô�ָ�������ִ�У��Ա�ӻ�����ȡ������ˣ���ʹ�Ǵӻ���Ͽ�˳����ȷ��ָ���ִ�е�˳��Ҳ�ǲ���Ԥ֪�ġ�</p>
<h3 id="����1"><a href="#����1" class="headerlink" title="����1"></a>����1</h3><p>�������һ���򵥵ĳ�����д������һ��foo�ṹ���󣬲������ĸ�����Ա��ʼ�����ٽ����foo����ĵ�ַ��ֵ��foo�ṹ��ָ��gp</p>
<p>?    </p>
<pre><code>struct foo &#123;
  int a;
  int b;
  int c;
&#125;;
struct foo *gp = NULL;
/* . . . */
p = kmalloc(sizeof(*p), GFP_KERNEL);
p-&gt;a = 1;
p-&gt;b = 2;
p-&gt;c = 3;
gp = p;
</code></pre>
<p>����������򵥴��������ܳ���Ľ��������Ԥ�ڣ�</p>
<p>?    </p>
<pre><code>p = gp;
if (p != NULL) &#123;
  do_something_with(p-&gt;a, p-&gt;b, p-&gt;c);
&#125;
</code></pre>
<p>����<strong>��������</strong> ��<code>gp = p;</code>���ܱ����õ���p�ĸ�����Ա��ʼ��֮ǰ�����˼�鵽gp�Ѿ���ʼ��������do_something_with����ʱ���ݵ�����Ƕ��ϵ�����ֵ��<br>��Ա������򣬿���ʹ������linux�ں˵�writel��readl��ʵ�֣�����<strong>�ڴ�����</strong> ָ��</p>
<p>?    </p>
<pre><code>#define barrier() __asm__ __volatile__(&quot;&quot;: : : &quot;memory&quot;)
</code></pre>
<p>barrier������c�����е�һ��դ�����������߼��ֳ����Σ�barrier֮ǰ�Ĵ����barrier֮��Ĵ����ھ��������������˳�����ҵ���Ҳ����˵��barrier֮���c�����Ӧ�Ļ�࣬�����ܵ�barrier֮ǰȥ����֮��Ȼ��</p>
<p>���barrier������Ƕ�����ʵ�֣��ƻ���������Ϊ��memory��<br>��memory��֪ͨ���������˶���Ƕ����޸���memory�е����ݣ�asm֮ǰ��c������֮���c����鿴����memory�����ǲ�һ���ģ���memory�ķ��ʲ�������֮ǰ�Ļ��棬��Ҫ���¼��ء�</p>
<p>�������ǿ���ͨ���ڴ����������ϱ���������ָ���������ŷţ�Ҳ���ܻ���Ϊ<strong>ִ������</strong> ���²������Ľ��������</p>
<h3 id="����2"><a href="#����2" class="headerlink" title="����2"></a>����2</h3><p>����һ�����ӣ�ARM v6&#x2F;v7�������������ָ��˳������Ż���<br>?    </p>
<pre><code>LDR r0�� [r1] ;
STR r2�� [r3] ;
</code></pre>
<p>�����һ��LDRָ��»���δ���У���������ͻ�����У���<strong>��Ҫ�϶��ʱ�����ڲ������</strong> ���ϵ�ARM������������ARM926EJ-S���<br>�����������ɣ���ִ����һ��STRָ���<strong>ARM<br>v6&#x2F;v7��������ʶ�����һ��ָ�STR���Ҳ���Ҫ�ȴ���һ��ָ�LDR����ɣ�����������r0��ֵ��?��������ִ��STRָ������ǵȴ�LDRָ����ɡ�</strong></p>
<p>���ڴ������ϵ�ṹ���ԣ�����ÿ��CPU��������ִ�У�������һ������ڵ��˵ĳ���ִ���ǲ��ɼ��ģ���Ϊ����CPU�����������㣨�����ָ��������ǰ��ָ���ִ�н������ʱ���ȴ������Գ���Ա���ܸо��������������̡��������������ȴ��Ĺ��̣���SMP��������������������ǲ��ɼ��ġ���������CPU0��ִ�У�</p>
<pre><code>while (f == 0);
print x;
</code></pre>
<p>��CPU1��ִ�У�</p>
<pre><code>x = 42;
f = 1;
</code></pre>
<p>���ǲ�����ϵ���ΪCPU0�ϴ�ӡ��xһ������42����Ϊ<strong>CPU1�ϼ��㡰f&#x3D;1�������ڡ�x&#x3D;42�����棬ִ��ʱ��Ȼ�������ڡ�x&#x3D;42�����</strong><br>���������ʱ��CPU0�ϴ�ӡ��x��һ������42��</p>
<p>������Ϊ��<strong>�����˼�һ���˵��ڴ���Ϊ������һ���˿ɼ�������</strong> ��������һЩ�ڴ����ϵ�ָ�Ʃ�磬ARM������������ָ�������</p>
<p>DMB�������ڴ����ϣ�?����DMB֮�����ʽ�ڴ����ִ��ǰ����֤������DMBָ��֮ǰ���ڴ������ɣ�<br>DSB������ͬ�����ϣ�?���ȴ�������DSBָ��֮ǰ��ָ����ɣ�λ�ڴ�ָ��ǰ��������ʽ�ڴ���ʾ���ɣ�λ�ڴ�ָ��ǰ�����л��桢��תԤ���TLBά������ȫ����ɣ�?��<br>ISB��ָ��ͬ�����ϣ�?��Flush��ˮ�ߣ�ʹ������ISB֮��ִ�е�ָ��Ǵӻ�����ڴ��л�õġ�</p>
<p>Linux�ں˵���������������Ȼ����߼�����Ҫ�õ�����ָ�����������ʱ����������ָ��ڽ���ʱ��Ҳ��Ҫ��������ָ�</p>
<h3 id="����3"><a href="#����3" class="headerlink" title="����3"></a>����3</h3><p>mutex_lock<br>?    </p>
<pre><code> 1LOCKED   EQU 1
 2UNLOCKED EQU 0
 3lock_mutex
 4     ; �������Ƿ�����?
 5     LDREX r1, [r0]         ; ����Ƿ�����
 6     CMP r1, #LOCKED        ; ��&quot;locked&quot;�Ƚ�
 7     WFEEQ                  ; �������Ѿ���������������
 8     BEQ lock_mutex         ; �����ѣ����¼�黥�����Ƿ�����
 9     ; ��������������
10     MOV r1, #LOCKED
11     STREX r2, r1, [r0]     ; ��������
12     CMP r2, #0x0           ; ���STRָ���Ƿ����
13     BNE lock_mutex         ; ���ʧ�ܣ�����
14     DMB                    ; ���뱻��������Դǰ��Ҫ���룬��֤�������Ѿ�������
15     BX lr
16
17unlock_mutex
18     DMB                    ; ��֤��Դ�ķ����Ѿ�����
19     MOV r1, #UNLOCKED      ; ��������д&quot;unlocked&quot;
20     STR r1, [r0]
21
22     DSB                    ; ��֤��CPU����ǰ��ɻ�����״̬����
23     SEV                    ; ������CPU�����¼��������κεȴ��¼���CPU
24
25     BX lr
</code></pre>
<h3 id="����4"><a href="#����4" class="headerlink" title="����4"></a>����4</h3><p>preempt_disable</p>
<p>������һ�����ӣ�<br>?    </p>
<pre><code>preempt_disable����

�ٽ���

preempt_enable
</code></pre>
<p>��Щ������Դ����ͨ����ֹ������ռ�����б���������ٽ������뱻preempt_disable��preempt_enable��������������ʵ������֪����ν��preempt<br>enable��disable��ʵ���ǶԵ�ǰ���̵�struct thread_info�е�preempt_count���м�һ�ͼ�һ�Ĳ���������Ĵ������£�</p>
<p>?    </p>
<pre><code>#define preempt_disable() \
do &#123; \
    preempt_count_inc(); \
    barrier(); \
&#125; while 
</code></pre>
<p>linux kernel�еĶ�������ǵ�����һ��������barrier����Ż����ϡ�barrier������c�����е�һ��դ�����������߼��ֳ����Σ�barrier֮ǰ�Ĵ����barrier֮��Ĵ����ھ��������������˳�����ҵ���Ҳ����˵��barrier֮���c�����Ӧ�Ļ�࣬�����ܵ�barrier֮ǰȥ����֮��Ȼ��֮������ô������Ϊ��������������У��������Ϊ��եȡCPU��performace���Ի��ָ��������ţ���ô�ٽ����Ĵ�����п���λ��preempt_count_inc֮�⣬�Ӷ��𲻵��������á�</p>
<h3 id="����5"><a href="#����5" class="headerlink" title="����5"></a>����5</h3><p>������� �C DMA����������</p>
<p>ǰ���ᵽÿ��CPU��������ִ�У����ǵ���CPU�������������ʱ���ȴ�������ִ������Ե��˲�һ���ɼ���</p>
<p>���ǣ��������ڷ�������ļĴ���ʱ����Щ�Ĵ����ķ���˳����CPU���߼��Ϲ�����������ϵ�����Ǵ�������߼��Ƕ�������������Ҫ�̶��ļĴ�����д˳�����ʱ��Ҳ��Ҫʹ��CPU���ڴ�����ָ�</p>
<p>��Linux�ں��У������˶�д����mb��?��?��������rmb��?��?��д����wmb��?��?���Լ������ڼĴ�����д��__iormb��?��?��__iowmb��?������������API����д�Ĵ�����readl_relaxed��?����readl��?��?��writel_relaxed��?����writel��?��API��������������������Ϸ��档</p>
<p>��������ͨ��writel_relaxed��?��д��DMA�Ŀ�ʼ��ַ��������ַ����С֮������һ��Ҫ����writel��?��������DMA��</p>
<pre><code>writel_relaxed(DMA_SRC_REG, src_addr);
writel_relaxed(DMA_DST_REG, dst_addr);
writel_relaxed(DMA_SIZE_REG, size);
writel (DMA_ENABLE, 1);
</code></pre>
<h3 id="ARM-Arch��Strongly-Order"><a href="#ARM-Arch��Strongly-Order" class="headerlink" title="ARM Arch��Strongly Order"></a>ARM Arch��Strongly Order</h3><p>����һ��uart��console write�ӿ�ʵ��demo��</p>
<pre><code>do &#123;
    ��ȡTX FIFO״̬�Ĵ���
    barrier();
&#125; while (TX FIFOû��ready);
дTX FIFO�Ĵ���;
</code></pre>
<p>һ����˵ARM�ܹ��£�����Ӳ����IO��ַҲ��ӳ�䵽��һ���ڴ��ַ�ռ䣬�Ա��������ԣ�������֪����Щ��ַ�ռ�����������ġ���ˣ���������Ĵ��룬<strong>���û��barrier�Ļ�����ȡTX FIFO״̬�Ĵ�����ָ����ܺ�дTX FIFO�Ĵ���ָ�����������������������£������߼��Ͳ����ˣ���Ϊ���Ǳ���Ҫ��֤TX FIFO<br>ready������²���дTX FIFO�Ĵ�����</strong></p>
<p>����multi core�����������Ĵ����߼�Ҳ��OK�ģ���Ϊ�ڵ���console write������ʱ��Ҫ��ȡһ��<strong>console semaphore</strong> ��ȷ����ֻ��һ��thread���룬��ˣ�console write�Ĵ��벻���ڶ��CPU�ϲ�����  </p>
<p>��preempt count������һ�������ǿ�����ͬ�������⣬���CPU������ִ�У�out-of-order<br>excution�����أ�<strong>barrierֻ�Ǳ�֤compiler����Ļ��ָ���˳����OK�ģ�����ȷ��CPUִ��ʱ�������</strong><br>���������Ļش�����ARM architecture���ڴ����ģ�ͣ�<br>����program order��A1�C&gt;A2�������A1��A2���Ƕ�Device����Strongly-ordered��memory���з��ʵ�ָ���ARM��֤A1Ҳ������A2ִ�еġ���ˣ��������ĳ����£�ʹ��barrier�㹻�ˡ�</p>
<p>����X86Ҳ�����Ƶģ���Ȼ��û�ж�IO space����memory<br>mapping�ķ�ʽ�����ǣ�X86�����в���IO�˿ڵ�ָ��Ǳ�˳ִ�еģ�����Ҫ����memory access order��</p>
<h3 id="BCM�ֲ��﷢�ֵ�һ��ϸ��"><a href="#BCM�ֲ��﷢�ֵ�һ��ϸ��" class="headerlink" title="BCM�ֲ��﷢�ֵ�һ��ϸ��"></a>BCM�ֲ��﷢�ֵ�һ��ϸ��</h3><p>BCM���������ӳ���ڴ���ʵ��ڴ�����Ҫ���ǲ����е�֣�������˼��ͬһ����������ڴ����˳�������Ա�֤�����������;�л�����һ�������Ҫʹ��memory barrier�������ܹ�Ҳ���ƣ�<br><img src="/../../stuff/BCD_MEM_barrier.png" alt="���������ͼƬ����"><br>BCD_MEM_barrier.png</p>

    </div>

    
    
    

    <footer class="post-footer">

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2024/10/28/uboot%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B%E6%A2%B3%E7%90%86/uboot1/" rel="prev" title="">
                  <i class="fa fa-angle-left"></i> 
                </a>
            </div>
            <div class="post-nav-item">
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2024</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">Luyuan</span>
  </div>
<div class="busuanzi-count">
    <span class="post-meta-item" id="busuanzi_container_site_uv">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="Total Visitors">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-item" id="busuanzi_container_site_pv">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="Total Views">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>
<!--
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/pisces/" rel="noopener" target="_blank">NexT.Pisces</a>
  </div> -->



    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/sidebar.js"></script><script src="/js/next-boot.js"></script>

  






  
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>





</body>
</html>
